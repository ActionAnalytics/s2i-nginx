#!/bin/bash -e
#
# S2I assemble script for the 's2i-nginx' image.
# The 'assemble' script builds your application source ready to run.
#
# For more information refer to the documentation:
#	https://github.com/openshift/source-to-image/blob/master/docs/builder_image.md
#
set -e

if [ "$1" = "-h" ]; then
	# If the 's2i-nginx' assemble script is executed with '-h' flag,
	# print the usage.
	exec /usr/local/s2i/usage
fi

NGINX_STATIC_DIR=${NGINX_STATIC_DIR-html}
NGINX_CONF_FILE=${NGINX_CONF_FILE-}
NGINX_CONF_DIR=${NGINX_CONF_DIR-conf.d}

copy_static_files() {
    echo "---> Copying static files"
    if [ -d /tmp/src/"${NGINX_STATIC_DIR}" ]; then
        cp -Rf /tmp/src/"${NGINX_STATIC_DIR}"/. ./html
    else
        cp -Rf /tmp/src/. ./html
    fi
}

copy_server_configs() {
    echo "---> Copying nginx config"
    rm /opt/app-root/etc/nginx.conf.d/default.conf

    if [ -n "${NGINX_SERVER_CONF_FILE}" -a -f /tmp/src/"${NGINX_SERVER_CONF_FILE}" ]; then
        cp /tmp/src/"${NGINX_SERVER_CONF_FILE}" /opt/app-root/etc/nginx.conf.d
    elif [ -n "${NGINX_CONF_DIR}" -a -d /tmp/src/"${NGINX_CONF_DIR}" ]; then
        cp -Rf /tmp/src/"${NGINX_CONF_DIR}"/* /opt/app-root/etc/nginx.conf.d
    else
        cp /opt/app-root/etc/nginx.server.sample.conf /opt/app-root/etc/nginx.conf.d/default.conf
    fi
}

test_config() {
    echo "---> testing config"
    $NGINX_BASE_DIR/usr/sbin/nginx -c /opt/app-root/etc/nginx.conf -t
}

cleanup() {
    echo "---> cleanup"
    rm -f /opt/app-root/run/nginx.pid $NGINX_VAR_DIR/log/nginx/error.log
}

copy_static_files
copy_server_configs
test_config
cleanup
